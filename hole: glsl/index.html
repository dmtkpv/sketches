<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo</title>
    <style>
        body {
            margin: 0;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>



<!--
    Vertex shader
-->

<script type="x-shader/x-vertex">

    attribute vec3 a_pos;

    void main() {
        gl_Position = vec4(a_pos.xyz, 1);
    }

</script>



<!--
    Fragment shader
-->

<script type="x-shader/x-fragment">

    precision mediump float;
    uniform float iTime;
    uniform vec2 iResolution;

    const float PI = 3.14;
    const int count = 10;


    vec2 getUv () {
        vec2 uv = gl_FragCoord.xy / iResolution;
        float sx = min(iResolution.x / iResolution.y, 1.);
        float sy = min(iResolution.y / iResolution.x, 1.);
        return (uv * 2. - 1.) * vec2(sx, sy);
    }

    float getY (float u) {
        float t = u * 10.;
        return (cos(t) + cos(t * 1.3 + 1.3) + cos(t * 1.4 + 1.4)) / 60.;
    }

    float getC (float y, float v) {
        return smoothstep(0., .004, abs(v - y));
    }

    void main() {

        vec2 uv = getUv();
        vec3 color = vec3(1);


        float D = .3,     // push distance
        n = 3.;     // slope after push: "back to normal" invdistance

        float l = length(uv), c;


        if (l > D) {

            uv /= l;
            // d' = f(d)        f(x) = (x^n+D^n)^(1/n)
            // d = f^-1(d')  f^-1(x) = (x^n-D^n)^(1/n)
            l *= c = pow( 1.-pow(D/l,n), 1./n );   // c = concentration
            uv *= l;

            for (int i = 0; i < count; i++) {

//                float oy = (1. - sy) - float(i) * sy;
                float oy = -0.1 + 0.2 * float(i) / float(count);
                float ox = float(i) * .3;
                float y = getY(uv.x + ox + iTime * float(i) / float(count)) + oy;
                float c = getC(y, uv.y);
                if (c < 1.) {
                    color = vec3(c * 5.);
                    break;
                }

            }

//            color = mix(vec3(1,1,1), color, c);
        }
        else if (l > D - 0.002) {
//            color = vec3(0);
        }


//        if (l + .2 < D) {
//            color -= 0.1;
//        }






        // [0.4, 0.6]
        // 0.1


        gl_FragColor = vec4(color, 1);


        // float r = sqrt(uv.x * uv.x + uv.y * uv.y);
        //
        // vec3 color = vec3(0);
        // if (r < 1.0) {
        // color = vec3(1);
        // }

        // uv *= vec2(sy, sx);


        //float a = fwidth(0.1);

        // vec3 color = vec3(0);
        // float line = 0.02;

        // float y = cos(uv.x * PI / 2.0);

        // color += 1.0 - smoothstep(0.0, line, abs(uv.y - y));
        // color += 1.0 - min(abs(uv.y - y), line) / line;


        // uv *= 16.;
        // color += 1.0 - smoothstep(0.0, line, abs(uv.y - floor(uv.y + .5)));
        // color += 1.0 - smoothstep(0.0, line, abs(uv.x - floor(uv.x + .5)));


        // 0->1
        // 0->16

        // x = 8.1
        // x - floor(x + .5) = 8.1 - floor(8.6) = 8.1 - 8 = 0.1 // 8.1
        // x - floor(x + .5) = 7.8 - floor(8.3) = 7.8 - 8 = 0.2 // 7.8

        // smoothstep(0.0, line, abs(uv.y - y));


    }

</script>



<!--
    Canvas
-->

<canvas></canvas>
<script src="index.js"></script>



</body>
</html>